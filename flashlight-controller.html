<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒãƒ›ãƒ©ã‚¤ãƒˆä¸€æ–‰åˆ¶å¾¡</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; background: #1a1a2e; min-height: 100vh; padding: 20px; color: white; }
        .container { max-width: 500px; margin: 0 auto; background: #16213e; border-radius: 20px; padding: 20px; }
        .mode-btn { flex: 1; padding: 12px; border: 2px solid #4facfe; background: transparent; color: #4facfe; border-radius: 10px; cursor: pointer; font-weight: bold; margin-bottom: 20px; width: 100%; }
        .section { display: none; }
        .section.active { display: block; }
        .qr-area { text-align: center; background: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .ctrl-btn { padding: 20px; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; font-size: 18px; }
        .btn-on { background: #e94560; } .btn-off { background: #0f3460; border: 1px solid #4facfe; } 
        .flashlight-display { width: 100%; height: 180px; border-radius: 15px; margin: 20px 0; display: flex; align-items: center; justify-content: center; font-size: 60px; }
        .off { background: #333; } .on { background: #f1c40f; box-shadow: 0 0 80px #f1c40f; }
        .perm-btn { width: 100%; padding: 25px; background: #e94560; color: white; border: none; border-radius: 15px; font-size: 20px; font-weight: bold; cursor: pointer; }
        #log { font-size: 12px; color: #ffeb3b; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 5px; margin-top: 10px; min-height: 60px; }
        video { position: fixed; top: -100px; width: 1px; height: 1px; opacity: 0; }
    </style>
</head>
<body>
    <div class="container">
        <div id="mode-ui">
            <button class="mode-btn" id="btn-toggle" onclick="toggleMode()">æ“ä½œå´/å‚åŠ å´ åˆ‡ã‚Šæ›¿ãˆ</button>
        </div>

        <div id="controller" class="section">
            <div class="qr-area"><div id="qrcode" style="display:inline-block;"></div></div>
            <div id="count" style="text-align:center; font-size:30px; margin:10px;">0</div>
            <div class="btn-grid">
                <button class="ctrl-btn btn-on" onclick="sendCmd('on')">ç‚¹ç¯</button>
                <button class="ctrl-btn btn-off" onclick="sendCmd('off')">æ¶ˆç¯</button>
            </div>
        </div>

        <div id="client" class="section">
            <button class="perm-btn" id="permBtn" onclick="initFlash()">ã€é–‹å§‹ã€‘ãƒ©ã‚¤ãƒˆã‚’æœ‰åŠ¹åŒ–</button>
            <div id="display" class="flashlight-display off">ğŸ’¡</div>
            <div id="log">ã“ã“ã«çŠ¶æ…‹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
            <video id="v" autoplay playsinline></video>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAELE9kEfoeShstaPaXYBBQJgiS49pWB0o",
            authDomain: "ledcontroller-b2655.firebaseapp.com",
            databaseURL: "https://ledcontroller-b2655-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ledcontroller-b2655",
            storageBucket: "ledcontroller-b2655.firebasestorage.app",
            messagingSenderId: "885689645868",
            appId: "1:885689645868:web:d05c56f76061c09fa70a89"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const sessionId = "room1";
        const clientId = "id_" + Math.random().toString(36).substr(2, 4);

        let track = null;

        function toggleMode() {
            const isClient = document.getElementById('client').classList.contains('active');
            setMode(isClient ? 'controller' : 'client');
        }

        function setMode(m) {
            document.getElementById('controller').classList.toggle('active', m === 'controller');
            document.getElementById('client').classList.toggle('active', m === 'client');
            if(m === 'controller') showQR();
        }

        function showQR() {
            const qrTarget = document.getElementById('qrcode');
            qrTarget.innerHTML = "";
            new QRCode(qrTarget, { text: window.location.href.split('?')[0] + "?m=c", width: 160, height: 160 });
            db.ref(`sessions/${sessionId}/clients`).on('value', s => {
                document.getElementById('count').innerText = s.val() ? Object.keys(s.val()).length : 0;
            });
        }

        function sendCmd(type) {
            db.ref(`sessions/${sessionId}/cmd`).set({ type: type, ts: Date.now() });
        }

        async function initFlash() {
            const logElement = document.getElementById('log');
            logElement.innerText = "ãƒ©ã‚¤ãƒˆä»˜ãã‚«ãƒ¡ãƒ©ã‚’æ¢ç´¢ä¸­...";
            
            try {
                // ã™ã¹ã¦ã®ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                
                let foundTrack = null;

                // èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’é †ç•ªã«è©¦ã—ã¦ãƒ©ã‚¤ãƒˆãŒã‚ã‚‹ã‹æ¢ã™
                for (const device of videoDevices) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { deviceId: { exact: device.deviceId } } 
                        });
                        const t = stream.getVideoTracks()[0];
                        const caps = t.getCapabilities();
                        
                        if (caps.torch) {
                            foundTrack = t;
                            document.getElementById('v').srcObject = stream;
                            break; 
                        } else {
                            // ãƒ©ã‚¤ãƒˆãŒãªã‘ã‚Œã°åœæ­¢ã—ã¦æ¬¡ã¸
                            t.stop();
                        }
                    } catch (e) { continue; }
                }

                if (!foundTrack) {
                    logElement.innerText = "ã‚¨ãƒ©ãƒ¼: ãƒ©ã‚¤ãƒˆä»˜ãã®ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ¨™æº–è¨­å®šã§å†è©¦è¡Œã—ã¾ã™ã€‚";
                    // äºˆå‚™ï¼šæ¨™æº–è¨­å®šã§è©¦ã™
                    const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    foundTrack = s.getVideoTracks()[0];
                }

                track = foundTrack;
                db.ref(`sessions/${sessionId}/clients/${clientId}`).set(true).then(() => {
                    db.ref(`sessions/${sessionId}/cmd`).on('value', snap => {
                        const data = snap.val();
                        if(data) setL(data.type === 'on');
                    });
                });

                document.getElementById('permBtn').style.display = 'none';
                logElement.innerText = "ãƒ©ã‚¤ãƒˆã‚’èªè­˜ã—ã¾ã—ãŸï¼æº–å‚™å®Œäº†ã§ã™ã€‚";

            } catch (e) {
                logElement.innerText = "ã‚¨ãƒ©ãƒ¼: " + e.message;
            }
        }

        async function setL(v) {
            if(!track) return;
            document.getElementById('display').className = v ? "flashlight-display on" : "flashlight-display off";
            try {
                await track.applyConstraints({ advanced: [{ torch: v }] });
            } catch (e) {
                document.getElementById('log').innerText = "ç‚¹ç¯å¤±æ•—: " + e.message;
            }
        }

        window.onload = () => {
            const p = new URLSearchParams(window.location.search);
            setMode(p.get('m') === 'c' ? 'client' : 'controller');
        };
    </script>
</body>
</html>
